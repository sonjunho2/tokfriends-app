name: Build Android APK (EAS)

on:
  workflow_dispatch: {}   # Actions íƒ­ì—ì„œ ìˆ˜ë™ ì‹¤í–‰

env:
  # ì„ íƒ: ì—¬ê¸°ì— EXPO_TOKENì„ ì£¼ìž…í•˜ë©´ ë³„ë„ ë¡œê·¸ì¸ ì»¤ë§¨ë“œ ì—†ì´ë„ ë™ìž‘í•©ë‹ˆë‹¤.
  # EXPO_TOKEN: ${{ secrets.EAS_TOKEN }}

jobs:
  build-apk:
    runs-on: ubuntu-latest

    # ëª¨ë…¸ë ˆí¬ê°€ ì•„ë‹ˆë©´ .(ë£¨íŠ¸)
    # ë§Œì•½ ì•±ì´ í•˜ìœ„ í´ë”(e.g. apps/mobile)ë©´ ì—¬ê¸°ë¥¼ ë°”ê¿”ì£¼ì„¸ìš”.
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install
        # ðŸ”¹ package-lock.jsonì´ ì—†ì–´ë„ ì„±ê³µí•©ë‹ˆë‹¤ (npm ciëŠ” ìž ì‹œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)

      - name: Install EAS CLI
        run: npm i -g eas-cli@latest

      # ë°©ë²• A) ìœ„ envì— EXPO_TOKENì„ ë„£ì—ˆìœ¼ë©´ ì´ ë‹¨ê³„ ìƒëžµ ê°€ëŠ¥
      - name: Expo login (using token)
        run: eas whoami || eas login --token ${{ secrets.EAS_TOKEN }}

      # (ì´ë¯¸ repoì— eas.jsonì´ ìžˆë‹¤ë©´ ê±´ë„ˆëœ€)
      - name: Ensure eas.json exists (noop if exists)
        run: |
          if [ ! -f "eas.json" ]; then
            echo '{
              "cli": { "version": ">= 3.20.0" },
              "build": {
                "apk": { "android": { "buildType": "apk" } },
                "production": { "android": { "buildType": "app-bundle" } }
              }
            }' > eas.json
          fi

      # ì‹¤ì œ ë¹Œë“œ (ì™„ë£Œê¹Œì§€ ëŒ€ê¸°)
      - name: Build APK
        run: eas build -p android --profile apk --non-interactive --wait

      # ê°€ìž¥ ìµœê·¼ ë¹Œë“œ ë‹¤ìš´ë¡œë“œ
      - name: Download APK
        run: eas build:download --latest --platform android --path ddakchin.apk

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ddakchin-apk
          path: ddakchin.apk
