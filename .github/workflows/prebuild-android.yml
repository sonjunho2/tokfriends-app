name: Prebuild Android (commit native)

on:
  workflow_dispatch: {}

permissions:
  contents: write  # android/ 폴더 커밋/푸시 위해 필요

jobs:
  prebuild-android:
    runs-on: ubuntu-latest
    env:
      CI: "1"           # ← --non-interactive 대신 필수
      EXPO_DEBUG: "1"   # ← --verbose 대신 상세 로그

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Show versions
        run: |
          node -v
          npm -v
          npx --version || true
          npx expo --version || true

      - name: Install deps
        run: npm install --no-audit --no-fund

      - name: Quick config/doctor (diagnostics)
        run: |
          npx expo config --json || true
          npx expo-doctor || true

      # 누락 시 prebuild가 막히는 경우 예방
      - name: Ensure expo-build-properties is installed
        run: |
          npm ls expo-build-properties || npm i -S expo-build-properties@0.6.0

      # ✅ --non-interactive, --verbose 제거. -p android 만 사용.
      - name: Expo prebuild (generate android/)
        run: |
          set -e
          npx expo prebuild -p android --clean 2>&1 | tee prebuild.log
          echo "---- repo root listing:"
          ls -la
          echo "---- android dir listing (if exists):"
          [ -d android ] && ls -la android || true

      - name: Commit & push android/
        run: |
          if [ -d android ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add android || true
            # iOS도 올리고 싶으면 아래 줄을 주석 해제
            # git add ios || true
            if ! git diff --cached --quiet; then
              git commit -m "chore(prebuild): add native android/ (generated by expo prebuild)"
              git push
            else
              echo "No changes to commit"
            fi
          else
            echo "Android folder not generated; showing prebuild.log for debugging:"
            [ -f prebuild.log ] && tail -n 200 prebuild.log || echo "prebuild.log not found"
            exit 1
          fi
